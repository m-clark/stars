# Extensions, Connections, & Generalizations

## Extensions 

### Interactions

We can implement interactions of multiple smooth terms. The following shows a model in which we could combine the effects of year and budget vis the <span class="func">te</span> function, along with the corresonding predictive plots.  

```{r gam2d, fig.show='hide', echo=1}
gam_model_2d = gam(rating ~  te(year, budget_2016) + votes + length, 
                      data=movies_yearly)
pd = visreg::visreg2d(gam_model_2d, 'year', 'budget_2016')[1:3] # for some reason 2d doesn't have a plot= argument
names(pd) = c('Year', 'Budget', 'Rating')
pd$Rating = t(pd$Rating)
# because of a lack of  sense, x is y in plotting 
```

```{r contourheat, echo=FALSE}
colfun = rev(colorRampPalette(RColorBrewer::brewer.pal(9, 'RdBu'))(100))
with(lapply(pd, round, 2),
     plot_ly(x=~Year, y=~Budget,  z=Rating, type='heatmap', colors=colfun, width='75%'))  %>%
  layout(paper_bgcolor='rgba(0,0,0,0)', plot_bgcolor='rgba(0,0,0,0)')
with(lapply(pd, round, 2), plot_ly(x=Year, y=Budget,  z = Rating, type='surface', hoverinfo='none', colors=colfun, width='75%',
                                   lighting=list(roughness=.01, ambient=.75), 
                                   contours=list(x=list(highlightcolor=toRGB('gray90'), width=1),
                                                 y=list(highlightcolor=toRGB('gray90'), width=1),
                                                 z=list(highlightcolor=toRGB('gray90'), width=1))))  %>% 
  layout(paper_bgcolor='rgba(0,0,0,0)', plot_bgcolor='rgba(0,0,0,0)')
```

While we see the general year effect where the earlier and more recent movies are associated with higher ratings, it would appear that for more recent times, lower ratings are associated with bigger budget movies.

There is also a way to do this interaction in a manner similar to ANOVA decomposition with both main effects and interaction.  See the <span class="func">ti</span> function.


### Grouped Effects

We can apply a smooth for a continuous covariate across levels of some grouping factor.  In the following, we'll apply let year have a different smooth effect for Action movies vs. other movies.

```{r gamby, echo=1}
gam_model_by = gam(rating ~  s(year, by=Action) + Action + budget_2016 + votes + length, 
                      data=movies_yearly_action)
gam_model_by = gam(rating ~  s(year, Action, bs='fs') + budget_2016 + votes + length, 
                      data=movies_yearly_action)
pd = visreg::visreg(gam_model_by, xvar='year', by='Action', plot=F)$fit
pd %>% 
  rename(fit = visregFit) %>% 
  plot_ly() %>% 
  add_lines(~year, ~fit, color=~Action) %>% 
  theme_plotly()
```

In this case there is more variability with Action movies, and their recent rise is not as sharp, but in general there doesn't seem to be too much differences.  Another alternative specifies a specific type of smooth that would be similar to random slopes in a mixed model. We now turn to the mixed model approach with GAMs.


### Mixed Models

Consider the matrix $Z$ that includes the basis functions, with associated coefficients $\gamma$, we could then write our model in matrix form as
follows:

$$ y = X\beta + Z\gamma + \epsilon$$

If you've spent much time with mixed models, that probably looks familiar to you. This penalized regression approach not only looks like the mixed model, we can exploit this to produce the same results.  The mgcv package has many tools for mixed models.

For this example I will use the sleep study data that comes with the lme4 package. It has reaction times for some tests where 18 subjects were restricted to 3 hours of sleep each night for 10 days. We fit a model with (uncorrelated) random intercepts and random slopes for Days.

```{r gamm, echo=1:7}
library(lme4)
mod_lme4 = lmer(Reaction ~ Days + (1|Subject) + (0 + Days|Subject), sleepstudy, REML=F)
mod_gamm = gam(Reaction ~ Days + s(Subject, bs='re') + s(Days, Subject, bs='re'), data=sleepstudy, method='ML')

# summary(mod_lme4)
# summary(mod_gamm)
VarCorr(mod_lme4)
gam.vcomp(mod_gamm)
cbind(ranef(mod_lme4)$Subject,
      Int_gamm = coef(mod_gamm)[3:20],
      Days_gamm = coef(mod_gamm)[21:length(coef(mod_gamm))]) %>% 
  round(2) %>% 
  rename(Int_mixed = `(Intercept)`,
         Days_mixed = Days) %>% 
  select(Int_mixed, Int_gamm, Days_mixed, Days_gamm) %>% 
  DT::datatable(options=list(dom='pt'))
```

The results are essentially identical. The <span class="pack">mgcv</span> package can also use <span class="pack">lme4</span> and <span class="pack">nlme</span> under the hood via other functions (<span class="pack">gamm4</span> package and <span class="func">gamm</span> function respectively). Extending GAMs into the mixed model world opens the door to some very powerful modeling possibilities.  
